global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon
    #tune.ssl.default-dh-param 2048

defaults
    log global
    option httplog
    option dontlognull
    timeout connect 5000ms
    timeout client  86400s
    timeout server  86400s
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http


{# === FRONTS === #}
{% include 'frontends/https_443_frontend.cfg.j2' %}


{# === BACKS === #}
{% for vhost in haproxy_http_vhosts if vhost.type == "http" %}
{% if vhost.template is defined %}
{# Si un template personnalisé est défini, on l'utilise #}
{% include 'vhosts/' + vhost.template %}
{% else %}
{# Sinon, on utilise le template générique par défaut (backend simple sans websocket) #}
backend {{ vhost.name }}_backend
    mode http
    option forwardfor
    timeout server 86400s

    server {{ vhost.name }} {{ vhost.backend_ip }}:{{ vhost.backend_port }} check

{% endif %}
{% endfor %}
